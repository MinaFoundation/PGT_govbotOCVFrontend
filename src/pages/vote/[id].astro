---
import MainLayout from '../../layouts/MainLayout.astro';
import WalletConnectButton from '../../components/WalletConnectButton.astro';
import NetworkSwitch from '../../components/NetworkSwitch.astro';
import VotingButtons from '../../components/VotingButtons.astro';
import Proposal from '../../models/Proposal';

const url = new URL(Astro.request.url);
const id = url.pathname.split('/').pop();

let proposal = null;
let error = null;

try {
  proposal = await Proposal.findByPk(id);
  if (!proposal) {
    error = 'Proposal not found';
  }
} catch (e) {
  error = 'Error fetching proposal';
}
---

<MainLayout title={proposal ? `Vote on ${proposal.name}` : 'Proposal Voting'}>
  <WalletConnectButton />
  <NetworkSwitch />
  
  {error ? (
    <p class="text-red-500 mt-4">{error}</p>
  ) : proposal ? (
    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-4">{proposal.name}</h2>
      <p class="mb-2"><strong>Proposal Link:</strong> <a href={proposal.uri} target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">{proposal.uri}</a></p>
      <p class="mb-4"><strong>Budget:</strong> {proposal.budget} MINA</p>
      <VotingButtons proposalId={proposal.id} />
    </div>
  ) : (
    <p class="mt-4">Loading proposal...</p>
  )}
</MainLayout>
